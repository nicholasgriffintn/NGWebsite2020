---
title: Adding authentication to our Express blog with Passport.js
published: true
description: Time to make things secure
tags: javascript,Node, Express, Passport.js,authentication
thumbnail: https://cdn.nicholasgriffin.dev/passport-thumbnail.png
header: https://nicholasgriffin.dev/uploads/bp/2019/March/users_js.jpg
ctime: 2019-04-19
---

In the last blog post we talked about [adding a blog to our personal site via Node, Express and Mongo](../../../../../../../../post-single?postID=5c7be6e2a1e5fbe51cd94950). In this blog post, we will be expanding upon that by adding authentication to our new Express APIs via something called Passport.js.

We will be going through the backend side of the code only during this post, creating a set of APIs for creating users, generating tokens for users, logging users in and requiring authentication for our APIs.

Let's get started.

## Setting up our app

For this post, I am going to expect that you have already set up a node environment, and have Mongo set up and ready to go. If you still need to do that, then it might be best to find a tutorial on how to do that before you follow this.

To start, you'll need to make sure that you have the following packages installed and included within your main application file:

<pre>const express = require('express');
const path = require('path');
const bodyParser = require('body-parser');
const session = require('express-session');
const cors = require('cors');
const mongoose = require('mongoose');
</pre>

Now you will need to configure Mongose to use global promises and setup Express to use your modules and set up your sessions.

<pre style="color: #000000; background: #ffffff;"><span style="color: #696969;">//Configure mongoose's promise to global promise</span>
mongoose<span style="color: #808030;">.</span>promise <span style="color: #808030;">=</span> <span style="color: #797997;">global</span><span style="color: #808030;">.</span>Promise<span style="color: #800080;">;</span>

<span style="color: #696969;">//Initiate our app</span>
<span style="color: #800000; font-weight: bold;">const</span> app <span style="color: #808030;">=</span> express<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

<span style="color: #696969;">//Configure our app</span>
app<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>cors<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
app<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">morgan</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">dev</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
app<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>bodyParser<span style="color: #808030;">.</span>urlencoded<span style="color: #808030;">(</span><span style="color: #800080;">{</span> extended<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
app<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>bodyParser<span style="color: #808030;">.</span>json<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
app<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>express<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">static</span><span style="color: #808030;">(</span>path<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">join</span><span style="color: #808030;">(</span>__dirname<span style="color: #808030;">,</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">public</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
app<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>session<span style="color: #808030;">(</span><span style="color: #800080;">{</span> secret<span style="color: #800080;">:</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">my-super-secret-key</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span> cookie<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> maxAge<span style="color: #800080;">:</span> <span style="color: #008c00;">60000</span> <span style="color: #800080;">}</span><span style="color: #808030;">,</span> resave<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span><span style="color: #808030;">,</span> saveUninitialized<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
</pre>

Make sure that you change your key to something really secret.

## Storing user data

Now that you have set up and configured your app, you will need to create your model for the Users database that you will need for the next steps.

To do this, you will need to create a new folder called "models" and then create a file within that folder called "Users.js".

We will be using this folder to define the schema for our users, hashing user passwords, generating a salt and creating the JWT that we will need latter. This file should look something like this:

<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> mongoose <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">mongoose</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> crypto <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">crypto</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> jwt <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">jsonwebtoken</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

<span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> Schema <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> mongoose<span style="color: #800080;">;</span>

<span style="color: #800000; font-weight: bold;">const</span> UsersSchema <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> Schema<span style="color: #808030;">(</span><span style="color: #800080;">{</span>
  email<span style="color: #800080;">:</span> <span style="color: #797997;">String</span><span style="color: #808030;">,</span>
  hash<span style="color: #800080;">:</span> <span style="color: #797997;">String</span><span style="color: #808030;">,</span>
  salt<span style="color: #800080;">:</span> <span style="color: #797997;">String</span><span style="color: #808030;">,</span>
<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

UsersSchema<span style="color: #808030;">.</span>methods<span style="color: #808030;">.</span>setPassword <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">function</span><span style="color: #808030;">(</span>password<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
  <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>salt <span style="color: #808030;">=</span> crypto<span style="color: #808030;">.</span>randomBytes<span style="color: #808030;">(</span><span style="color: #008c00;">16</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">toString</span><span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">hex</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
  <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>hash <span style="color: #808030;">=</span> crypto<span style="color: #808030;">.</span>pbkdf2Sync<span style="color: #808030;">(</span>password<span style="color: #808030;">,</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>salt<span style="color: #808030;">,</span> <span style="color: #008c00;">10000</span><span style="color: #808030;">,</span> <span style="color: #008c00;">512</span><span style="color: #808030;">,</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">sha512</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">toString</span><span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">hex</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800080;">}</span><span style="color: #800080;">;</span>

UsersSchema<span style="color: #808030;">.</span>methods<span style="color: #808030;">.</span>validatePassword <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">function</span><span style="color: #808030;">(</span>password<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
  <span style="color: #800000; font-weight: bold;">const</span> hash <span style="color: #808030;">=</span> crypto<span style="color: #808030;">.</span>pbkdf2Sync<span style="color: #808030;">(</span>password<span style="color: #808030;">,</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>salt<span style="color: #808030;">,</span> <span style="color: #008c00;">10000</span><span style="color: #808030;">,</span> <span style="color: #008c00;">512</span><span style="color: #808030;">,</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">sha512</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">toString</span><span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">hex</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
  <span style="color: #800000; font-weight: bold;">return</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>hash <span style="color: #808030;">===</span> hash<span style="color: #800080;">;</span>
<span style="color: #800080;">}</span><span style="color: #800080;">;</span>

UsersSchema<span style="color: #808030;">.</span>methods<span style="color: #808030;">.</span>generateJWT <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">function</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
  <span style="color: #800000; font-weight: bold;">const</span> today <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> <span style="color: #797997;">Date</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
  <span style="color: #800000; font-weight: bold;">const</span> expirationDate <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> <span style="color: #797997;">Date</span><span style="color: #808030;">(</span>today<span style="color: #808030;">)</span><span style="color: #800080;">;</span>
  expirationDate<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">setDate</span><span style="color: #808030;">(</span>today<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">getDate</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #808030;">+</span> <span style="color: #008c00;">60</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

  <span style="color: #800000; font-weight: bold;">return</span> jwt<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">sign</span><span style="color: #808030;">(</span><span style="color: #800080;">{</span>
    email<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>email<span style="color: #808030;">,</span>
    id<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>_id<span style="color: #808030;">,</span>
    <span style="color: #800000; font-weight: bold;">exp</span><span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">parseInt</span><span style="color: #808030;">(</span>expirationDate<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">getTime</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #808030;">/</span> <span style="color: #008c00;">1000</span><span style="color: #808030;">,</span> <span style="color: #008c00;">10</span><span style="color: #808030;">)</span><span style="color: #808030;">,</span>
  <span style="color: #800080;">}</span><span style="color: #808030;">,</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">secret</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800080;">}</span>

UsersSchema<span style="color: #808030;">.</span>methods<span style="color: #808030;">.</span>toAuthJSON <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">function</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
  <span style="color: #800000; font-weight: bold;">return</span> <span style="color: #800080;">{</span>
    _id<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>_id<span style="color: #808030;">,</span>
    email<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>email<span style="color: #808030;">,</span>
    token<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>generateJWT<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #808030;">,</span>
  <span style="color: #800080;">}</span><span style="color: #800080;">;</span>
<span style="color: #800080;">}</span><span style="color: #800080;">;</span>

mongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">Users</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span> UsersSchema<span style="color: #808030;">)</span><span style="color: #800080;">;</span>
</pre>

To use this model, you will need to add the following to your application file under the line where you are settiing up Mongo.

<pre>require('./models/Users');</pre>

## Setting up our Passport.js config

Now that we have set up our users model, we are ready to get started with our configuration for Passport.js.

To do this and keep it tidy we will need to create a new folder called "config", which we will be using for the storage of our configuration files for this part and for future requirements.

Within this folder, we need to create a new file named "passport.js".

<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> mongoose <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">mongoose</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> passport <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">passport</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> LocalStrategy <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">passport-local</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

<span style="color: #800000; font-weight: bold;">const</span> Users <span style="color: #808030;">=</span> mongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">Users</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

passport<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span><span style="color: #800000; font-weight: bold;">new</span> LocalStrategy<span style="color: #808030;">(</span><span style="color: #800080;">{</span>
  usernameField<span style="color: #800080;">:</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">user[email]</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span>
  passwordField<span style="color: #800080;">:</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">user[password]</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span>
<span style="color: #800080;">}</span><span style="color: #808030;">,</span> <span style="color: #808030;">(</span>email<span style="color: #808030;">,</span> password<span style="color: #808030;">,</span> done<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
  Users<span style="color: #808030;">.</span>findOne<span style="color: #808030;">(</span><span style="color: #800080;">{</span> email <span style="color: #800080;">}</span><span style="color: #808030;">)</span>
    <span style="color: #808030;">.</span>then<span style="color: #808030;">(</span><span style="color: #808030;">(</span>user<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
      <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user <span style="color: #808030;">||</span> <span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>validatePassword<span style="color: #808030;">(</span>password<span style="color: #808030;">)</span><span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
        <span style="color: #800000; font-weight: bold;">return</span> done<span style="color: #808030;">(</span><span style="color: #0f4d75;">null</span><span style="color: #808030;">,</span> <span style="color: #0f4d75;">false</span><span style="color: #808030;">,</span> <span style="color: #800080;">{</span> errors<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">email or password</span><span style="color: #800000;">'</span><span style="color: #800080;">:</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">is invalid</span><span style="color: #800000;">'</span> <span style="color: #800080;">}</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
      <span style="color: #800080;">}</span>

      <span style="color: #800000; font-weight: bold;">return</span> done<span style="color: #808030;">(</span><span style="color: #0f4d75;">null</span><span style="color: #808030;">,</span> user<span style="color: #808030;">)</span><span style="color: #800080;">;</span>
    <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">catch</span><span style="color: #808030;">(</span>done<span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
</pre>

This will basically use our password validation function from users to direct the user to the correct output.

To link this all together, you will need to add the following line after your model set up:

<pre style="color: #000000; background: #ffffff;">require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">./config/passport</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
</pre>

## Setting up our authentication route

The final step is to set up a route that can be used for authentication.

To do this, we will create a new folder named "routes" and then within that, we will create a file named "auth.js". This will contain a function for getting a token from the user's request headers.

It does this by looking for a header named authorization and then splitting everything in the value after the word 'Token', the part that is returned should be our JWT.

If a JWT cannnot be found it will return null, which we can use to display an error through the API later.

<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> jwt <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">express-jwt</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

<span style="color: #800000; font-weight: bold;">const</span> getJWT <span style="color: #808030;">=</span> <span style="color: #808030;">(</span>req<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
  <span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> headers<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> authorization <span style="color: #800080;">}</span> <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> req<span style="color: #800080;">;</span>

  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span>authorization <span style="color: #808030;">&&</span> authorization<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">split</span><span style="color: #808030;">(</span><span style="color: #800000;">'</span> <span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">[</span><span style="color: #008c00;">0</span><span style="color: #808030;">]</span> <span style="color: #808030;">===</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">Token</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
    <span style="color: #800000; font-weight: bold;">return</span> authorization<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">split</span><span style="color: #808030;">(</span><span style="color: #800000;">'</span> <span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">[</span><span style="color: #008c00;">1</span><span style="color: #808030;">]</span><span style="color: #800080;">;</span>
  <span style="color: #800080;">}</span>
  <span style="color: #800000; font-weight: bold;">return</span> <span style="color: #0f4d75;">null</span><span style="color: #800080;">;</span>
<span style="color: #800080;">}</span><span style="color: #800080;">;</span>
</pre>

We then need to create our variable for both required and optional authenticatiion methods and then finally export that variable:

<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> auth <span style="color: #808030;">=</span> <span style="color: #800080;">{</span>
  required<span style="color: #800080;">:</span> jwt<span style="color: #808030;">(</span><span style="color: #800080;">{</span>
    secret<span style="color: #800080;">:</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">secret</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span>
    userProperty<span style="color: #800080;">:</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">payload</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span>
    getToken<span style="color: #800080;">:</span> getJWT<span style="color: #808030;">,</span>
  <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">,</span>
  optional<span style="color: #800080;">:</span> jwt<span style="color: #808030;">(</span><span style="color: #800080;">{</span>
    secret<span style="color: #800080;">:</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">secret</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span>
    userProperty<span style="color: #800080;">:</span> <span style="color: #800000;">'</span><span style="color: #0000e6;">payload</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span>
    getToken<span style="color: #800080;">:</span> getJWT<span style="color: #808030;">,</span>
    credentialsRequired<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span><span style="color: #808030;">,</span>
  <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">,</span>
<span style="color: #800080;">}</span><span style="color: #800080;">;</span>

module<span style="color: #808030;">.</span>exports <span style="color: #808030;">=</span> auth<span style="color: #800080;">;</span>
</pre>

Now we need to link all of this to an API.

To do that, create a new file in your routes folder called "index.js" and add the following code to it:

<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> express <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">express</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> router <span style="color: #808030;">=</span> express<span style="color: #808030;">.</span>Router<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

router<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">/api</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">./api</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

module<span style="color: #808030;">.</span>exports <span style="color: #808030;">=</span> router<span style="color: #800080;">;</span>
</pre>

This will basically set up a new route that will link requests with the api pathname to a folder called api within our routes folder.

Create that api folder within your routes folder and then create another "index.js" file within that folder with the following:

<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> express <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">express</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> router <span style="color: #808030;">=</span> express<span style="color: #808030;">.</span>Router<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

router<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">/users</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">./users</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

module<span style="color: #808030;">.</span>exports <span style="color: #808030;">=</span> router<span style="color: #800080;">;</span>
</pre>

And then, as you might have guessed from the code, we will need to create another file within the api folder called "users.js".

This is . where you will host your users APIs.

## Creating your Users APIs

To start off, add the following to the top of your new file:

<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> mongoose <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">mongoose</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> passport <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">passport</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> router <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">express</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>Router<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> auth <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">../auth</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> Users <span style="color: #808030;">=</span> mongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">Users</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
</pre>

You'll then need to add the following after that to register your APIs.

**New user API**

<pre style="color: #000000; background: #ffffff;">router<span style="color: #808030;">.</span>post<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">/</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span> auth<span style="color: #808030;">.</span>optional<span style="color: #808030;">,</span> <span style="color: #808030;">(</span>req<span style="color: #808030;">,</span> res<span style="color: #808030;">,</span> next<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
  <span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> body<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> user <span style="color: #800080;">}</span> <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> req<span style="color: #800080;">;</span>

  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>email<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
    <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">422</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>send<span style="color: #808030;">(</span><span style="color: #800000;">"</span><span style="color: #0000e6;">Something unexpected happened</span><span style="color: #800000;">"</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
  <span style="color: #800080;">}</span>

  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>password<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
    <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">422</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>send<span style="color: #808030;">(</span><span style="color: #800000;">"</span><span style="color: #0000e6;">Something unexpected happened</span><span style="color: #800000;">"</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
  <span style="color: #800080;">}</span>

  <span style="color: #800000; font-weight: bold;">const</span> returnedUser <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> Users<span style="color: #808030;">(</span>user<span style="color: #808030;">)</span><span style="color: #800080;">;</span>

  returnedUser<span style="color: #808030;">.</span>setPassword<span style="color: #808030;">(</span>user<span style="color: #808030;">.</span>password<span style="color: #808030;">)</span><span style="color: #800080;">;</span>

  <span style="color: #800000; font-weight: bold;">return</span> returnedUser<span style="color: #808030;">.</span>save<span style="color: #808030;">(</span><span style="color: #808030;">)</span>
    <span style="color: #808030;">.</span>then<span style="color: #808030;">(</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> res<span style="color: #808030;">.</span>json<span style="color: #808030;">(</span><span style="color: #800080;">{</span> user<span style="color: #800080;">:</span> returnedUser<span style="color: #808030;">.</span>toAuthJSON<span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
</pre>

**Login API**

<pre style="color: #000000; background: #ffffff;">router<span style="color: #808030;">.</span>post<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">/login</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span> auth<span style="color: #808030;">.</span>optional<span style="color: #808030;">,</span> <span style="color: #808030;">(</span>req<span style="color: #808030;">,</span> res<span style="color: #808030;">,</span> next<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
  <span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> body<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> user <span style="color: #800080;">}</span> <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> req<span style="color: #800080;">;</span>

  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>email<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
    <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">422</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
  <span style="color: #800080;">}</span>

  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>password<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
    <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">422</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
  <span style="color: #800080;">}</span>

  <span style="color: #800000; font-weight: bold;">return</span> passport<span style="color: #808030;">.</span>authenticate<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">local</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span> <span style="color: #800080;">{</span> session<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span> <span style="color: #800080;">}</span><span style="color: #808030;">,</span> <span style="color: #808030;">(</span>err<span style="color: #808030;">,</span> passportUser<span style="color: #808030;">,</span> info<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
    <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span>err<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
      <span style="color: #800000; font-weight: bold;">return</span> next<span style="color: #808030;">(</span>err<span style="color: #808030;">)</span><span style="color: #800080;">;</span>
    <span style="color: #800080;">}</span>

    <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span>passportUser<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
      <span style="color: #800000; font-weight: bold;">const</span> user <span style="color: #808030;">=</span> passportUser<span style="color: #800080;">;</span>
      user<span style="color: #808030;">.</span>token <span style="color: #808030;">=</span> passportUser<span style="color: #808030;">.</span>generateJWT<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

      <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>json<span style="color: #808030;">(</span><span style="color: #800080;">{</span> user<span style="color: #800080;">:</span> user<span style="color: #808030;">.</span>toAuthJSON<span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
    <span style="color: #800080;">}</span>

    <span style="color: #800000; font-weight: bold;">return</span> status<span style="color: #808030;">(</span><span style="color: #008c00;">400</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>info<span style="color: #800080;">;</span>
  <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">(</span>req<span style="color: #808030;">,</span> res<span style="color: #808030;">,</span> next<span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
</pre>

## Adding authentication to our APIs

Now you are ready to add authentication to your APIs! Here's an example with the addpost API that I talked about in the last post about creating a blog within Mongo:

<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> mongoose <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">mongoose</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> passport <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">passport</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> router <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">express</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>Router<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> auth <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">../auth</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> Users <span style="color: #808030;">=</span> mongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">Users</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800000; font-weight: bold;">const</span> Post <span style="color: #808030;">=</span> mongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">Post</span><span style="color: #800000;">'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>

<span style="color: #696969;">// For creating posts</span>
router<span style="color: #808030;">.</span>post<span style="color: #808030;">(</span><span style="color: #800000;">'</span><span style="color: #0000e6;">/addpost</span><span style="color: #800000;">'</span><span style="color: #808030;">,</span> auth<span style="color: #808030;">.</span>required<span style="color: #808030;">,</span> <span style="color: #808030;">(</span>req<span style="color: #808030;">,</span> res<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
  <span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> payload<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> id <span style="color: #800080;">}</span> <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> req<span style="color: #800080;">;</span>

  <span style="color: #800000; font-weight: bold;">return</span> Users<span style="color: #808030;">.</span>findById<span style="color: #808030;">(</span>id<span style="color: #808030;">)</span>
    <span style="color: #808030;">.</span>then<span style="color: #808030;">(</span><span style="color: #808030;">(</span>user<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
      <span style="color: #800000; font-weight: bold;">if</span> <span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>
        <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>sendStatus<span style="color: #808030;">(</span><span style="color: #008c00;">400</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
      <span style="color: #800080;">}</span>

      <span style="color: #800000; font-weight: bold;">var</span> postData <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> Post<span style="color: #808030;">(</span>req<span style="color: #808030;">.</span>body<span style="color: #808030;">)</span><span style="color: #800080;">;</span>
      postData<span style="color: #808030;">.</span>save<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>then<span style="color: #808030;">(</span>result <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
        res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">200</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>send<span style="color: #808030;">(</span><span style="color: #800000;">"</span><span style="color: #0000e6;">Post saved.</span><span style="color: #800000;">"</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
      <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">catch</span><span style="color: #808030;">(</span>err <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>
        res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">400</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>send<span style="color: #808030;">(</span><span style="color: #800000;">"</span><span style="color: #0000e6;">Unable to save data</span><span style="color: #800000;">"</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
      <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
    <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>
</pre>

## And that's it!

You have now successfully added authentication to your Node Express setup. Next up is creating a full frontend system with a login and dashboard page for our blog

![](https://media.giphy.com/media/bWS1Vh9mVkcZq/giphy.gif)